---
title:  |  
  | *Multivariate Analysis for the Behavioral Sciences,*
  | **Examples of Chapter 10:**
  | **Analysis of Longitudinal Data III: Non-Normal Responses**
author: |
  | Kimmo Vehkalahti, Brian S. Everitt; edited by C.-F. Sheu
  |
date: '`r format(Sys.time(), "%d %B, %Y")`'
output: 
  rmarkdown::github_document:
  pdf_document:
    number_sections: no
    toc: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  message = FALSE,
  fig.align = 'center',
  comment = "",
  tidy = FALSE,     # display code as typed
  size = "small")   # slightly smaller font for code)
```


```{r message=FALSE, warning=FALSE}
# check to see if the pacman package is there
# if not install it and then use it manage packages
if (!require(pacman)) install.packages("pacman")
pacman::p_load(tidyverse, gee, lme4, HSAUR3)
```

\pagebreak

## Example: Epilepsy

A randomised clinical trial was conduted to investigate the effect of an anti-epileptic drug.
In the study, 59 patients suffering from epilepsy were randomized to groups receiving either the anti-epileptic drug Progabide or a placebo in addition to standard chemotherapy. The numbers of seizures suffered in each of four, two-week periods were recorded for each patient along with a baseline seizure count for the 8 weeks prior to being randomized to treatment and age. 
The number of epileptic seizures before and after treatment
separately for the two treatment groups (the before count is the two-week
average).

The main question of interest is whether taking progabide reduced the number of epileptic seizures compared with placebo.


\pagebreak

## Table 10.2: Data from a Clinical Trial of Patients Suffering from Epilepsy

Data are in long form.

```{r}
data(epilepsy, package = "HSAUR3")
```

```{r}
# make a copy
EPIL <- HSAUR3::epilepsy 
```

```{r}
glimpse(EPIL); head(EPIL)
```

```{r}
# convert data to WIDE form:
# (sep: set valid names month0:month4 here! otherwise just 0:4)
EPI <- EPIL %>% 
  spread(key = period, value = seizure.rate, sep = "") %>% 
  arrange(subject)
```

```{r}
glimpse(EPI); head(EPI)
```

```{r}
#correct the baseline when converting to long form:
EPIL <- gather(EPI, key = periods, value = seizure.rate, period1:period4) %>%
  mutate( base2 = base/4, week = as.integer(substr(periods, 7, 7)) ) %>% 
  arrange(subject)
```

```{r}
glimpse(EPIL); head(EPIL)
```

\pagebreak

## Figure 10.3

```{r}
# Convert data to long form, including the baseline;
# correct the baseline first:
EPIL0 <- EPI %>% 
  mutate(base2 = base/4) %>%
  gather(., key = periods, value = seizure.rate, base2, period1:period4) %>% 
  arrange(subject)
```

```{r}
glimpse(EPIL0); head(EPIL0)
```

[Mark some of the outliers:](https://stackoverflow.com/questions/33524669/labeling-outliers-of-boxplots-in-r)

```{r}
# changed the upper coeff from 1.5 to 3.5 (only more extreme observations highlighted)
is_outlier <- function(x) {
  return(x < quantile(x, 0.25) - 1.5 * IQR(x) | x > quantile(x, 0.75) + 3.5 * IQR(x))
}
```

```{r}
# use subject id (not seizure.rate itself!) for identification:
EPIL0 <- EPIL0 %>%
  mutate(outlier = ifelse(is_outlier(seizure.rate), subject, as.numeric(NA)))
```

```{r fig10.3}
ggplot(EPIL0, aes(x = factor(periods), y = seizure.rate, fill = treatment)) + 
  geom_boxplot() + 
  geom_text(aes(label = outlier), na.rm = TRUE, hjust = -0.6) +
  facet_grid(treatment ~ ., labeller = label_parsed) + 
  theme_bw() + 
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank()) +
  theme(legend.position = "none") + 
  scale_x_discrete(name = "", 
                   labels = c("Baseline", "Time 1", "Time 2", "Time 3", "Time 4")) + 
  scale_y_continuous(name = "Seizure rate (count)") +
  scale_fill_grey(start = 1, end = 1) 
```

## Table 10.8

```{r}
t1 <- as.data.frame(tapply(EPIL0$seizure.rate, EPIL0$period, mean))
t2 <- as.data.frame(tapply(EPIL0$seizure.rate, EPIL0$period, var))
tab108 <- cbind(t1, t2)
names(tab108) = c("mean", "variance")
tab108
```

\pagebreak

## Table 10.9

```{r}
xnam <- c(names(EPIL)[c(1,3,8)], "log(base2)")
(fmla5 <- as.formula(paste("seizure.rate ~ ", paste(xnam, collapse= "+"))))
```


```{r}
epil_gee1 <- gee(fmla5, data = EPIL, 
                 family = "poisson", id = subject, 
                 corstr = "exchangeable", scale.fix = FALSE)
```

```{r}
summary(epil_gee1)
```

\pagebreak

## Table 10.11

```{r}
# set up the model formula for lme4
(fmla6 <- as.formula(paste("seizure.rate ~ ", 
                           paste0(paste(xnam, collapse = "+"), 
                                  " + (1 | subject)"))))

```

```{r}
epil_glmm <- lme4::glmer(fmla6, data = EPIL, family = "poisson")
```

```{r}
summary(epil_glmm)
```

\pagebreak

## Table 10.12

```{r}
# set up the model formula for lme4
(fmla7 <- as.formula(paste("seizure.rate ~ ", 
                           paste0(paste(xnam, collapse = "+"), 
                                  " + (1 + week | subject)"))))

```

```{r}
epil_glmm2 <- lme4::glmer(fmla7, data = EPIL, family = "poisson")
```

```{r}
summary(epil_glmm2)
```

\pagebreak

## Session information

```{r session_info, include=FALSE}
# set include=TRUE to view the results
sessionInfo()
```