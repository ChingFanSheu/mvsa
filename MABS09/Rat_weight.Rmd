---
title:  |  
  |  *Multivariate Analysis for the Behavioral Sciences,*
  |  **Examples of Chapter 9:**
  |  **Analysis of Longitudinal Data II: Linear Mixed Effects Models for Normal Response Variables**
author: |
  | "Kimmo Vehkalahti, Brian S. Everitt; edited by C.-F. Sheu"
  |
date: '`r format(Sys.time(), "%d %B, %Y")`'
output: 
  rmarkdown::github_document:
  pdf_document:
    latex_engine: xelatex
    number_sections: no
    toc: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  message = FALSE,
  fig.align = 'center',
  comment = "",
  tidy = FALSE,     # display code as typed
  size = "small")   # slightly smaller font for code)
```


\pagebreak

## Example: Rat weight over time for different diets

Data from a nutrition study conducted in three groups of rats
The three groups were put on different diets, and
each animalâ€™s body weight (grams) was recorded repeatedly (approximately weekly, except in week seven when two recordings were taken) over a 9-week period. 
The question of most interest is whether the growth profiles of the
three groups differ.

```{r message=FALSE, warning=FALSE}
# check to see if the pacman package is there
# if not install it and then use it manage packages
if (!require(pacman)) install.packages("pacman")
pacman::p_load(tidyverse, nlme, lme4, gridExtra)
```

## Table 9.1: Body Weights of Rats 

```{r}
# file location
fLoc <- "https://raw.githubusercontent.com/KimmoVehkalahti/MABS/master/Examples/data/rats.txt"
```

```{r}
# data input
RATS <- read.table(fLoc, header = TRUE, sep = '\t')
```

```{r}
RATS <- within(RATS, {
  ID <- factor(ID)
  Group <- factor(Group)})
```

```{r}
glimpse(RATS)
```

The data set in also available from the *nlme* package
as a grouped data frame object called *BodyWeight*.

```{r}
knitr::kable(head(nlme::BodyWeight, 15))
```


```{r}
RATSL <- nlme::BodyWeight
```

```{r}
names(RATSL) <- c("Weight", "Time", "ID", "Group")
```

```{r}
glimpse(RATSL)
```


\pagebreak

## Figure 9.1

```{r}
# set black and white theme
ot <- theme_set(theme_bw())
```


```{r fig9.1}
ggplot(data = RATSL, aes(x = Time, y = Weight, group = ID)) +
  geom_text(aes(label = Group)) + 
  scale_x_continuous(name = "Time (days)", breaks = seq(0, 60, 10)) +
  scale_y_continuous(name = "Weight (grams)") + 
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank())
```

\pagebreak

## Table 9.3

```{r}
RATS_reg <- lm(Weight ~ Time + Group, data = RATSL)
summary(RATS_reg)
# dummies (in Table) vs summary output: D1 = Group2, D2 = Group3
```

\pagebreak

## Figure 9.2

```{r fig9.2}
ggplot(RATSL, aes(x = Time, y = Weight, group = ID)) +
  geom_line(aes(linetype = Group)) + 
  scale_x_continuous(name = "Time (days)", breaks = seq(0, 60, 10)) +
  scale_y_continuous(name = "Weight (grams)") + 
  theme(legend.position = "top") + 
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank())
```

\pagebreak

## Figure 9.3

```{r fig9.3, fig.width = 10, fig.height = 10, fig.align='center'}
pairs(RATS[, 3:13], cex = 0.7)
```

\pagebreak

## Table 9.4

```{r}
RATS_ref <- lme4::lmer(Weight ~ Time + Group + (1 | ID), 
                       data = RATSL, REML = FALSE)
summary(RATS_ref)
# dummies (in Table) vs summary output: D1 = Group2, D2 = Group3
```

\pagebreak

## Table 9.5

```{r}
RATS_ref1 <- lme4::lmer(Weight ~ Time + Group + (Time | ID), 
                        data = RATSL, REML = FALSE)
summary(RATS_ref1)
# dummies (in Table) vs summary output: D1 = Group2, D2 = Group3
```

```{r}
anova(RATS_ref1, RATS_ref)
```

\pagebreak

## Table 9.6

```{r}
RATS_ref2 <- lme4::lmer(Weight ~ Time * Group + (Time | ID), 
                        data = RATSL, REML = FALSE)
summary(RATS_ref2)
# dummies (in Table) vs summary output: D1 = Group2, D2 = Group3
```

```{r}
anova(RATS_ref1, RATS_ref2)
```

\pagebreak

## Figure 9.4

```{r}
# add fitted values to he original data frame 
RATSL <- data.frame(RATSL, Fitted = fitted(RATS_ref2))
```

```{r fig9.4}
# observed
g1 <- ggplot(RATSL, aes(x = Time, y = Weight, group = ID)) +
  geom_line(aes(linetype = Group)) + 
  scale_x_continuous(name = "Time (days)", breaks = seq(0, 60, 20)) +
  scale_y_continuous(name = "Weight (grams)") + 
  # "none" in the book
  theme(legend.position = "right") + 
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank()) +
  ggtitle("Observed")
# fitted
g2 <- ggplot(RATSL, aes(x = Time, y = Fitted, group = ID)) +
  geom_line(aes(linetype = Group)) + 
  scale_x_continuous(name = "Time (days)", breaks = seq(0, 60, 20)) +
  scale_y_continuous(name = "Weight (grams)") + 
  theme(legend.position = "right") + 
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank()) + 
  ggtitle("Fitted")
# side by side
grid.arrange(g1, g2, nrow = 1)
```

\pagebreak

## Session information

```{r session_info, include=FALSE}
# set include=TRUE to view the results
devtools::session_info()
```